---
import { getEntry, render } from "astro:content"
import { format } from "date-fns"

import Link from "@/components/Link.astro"
import LanguageLabel from "@/components/LanguageLabel.astro"
import PostTranslationLinks from "@/components/PostTranslationLinks.astro"

import { getLanguageEnglishDisplay, getTranslations, getCategoryDisplay } from "@/utils/content"

import type { CollectionEntry } from "astro:content"

interface Props {
  note: CollectionEntry<"notes">
  showLink?: boolean
}

const { note, showLink = true } = Astro.props
const { Content } = await render(note)
const post = note.data.post ? await getEntry(note.data.post) : null
const translations = post ? getTranslations(post) : []
---

<div>
  <!-- Link to the post -->
  {post && (
    <p>
      {post.data.lang !== "en" && <LanguageLabel lang={post.data.lang} />}
      <Link href={`/posts/${post.id}`} lang={post.data.lang} class="font-bold">{post.data.title}</Link>
    </p>
  )}

  <!-- Content -->
  <div class="mb-4">
    <Content />
  </div>

  <!-- Post translations -->
  {post && translations.length > 0 && (
    <p>The post was written in {getLanguageEnglishDisplay(post.data.lang)}, and translations are available below.</p>
    <p><PostTranslationLinks translations={translations} /></p>
  )}

  <!-- Category and tags -->
  <div class="mb-1 text-xs text-neutral-500">
    <Link href={`/notes/categories/${note.data.category}`} class="font-bold">{getCategoryDisplay(note.data.category)}</Link>{note.data.tags && note.data.tags.length > 0 && <span class="text-neutral-500">, </span>}
    {note.data.tags?.map((tag, index) => <Fragment><Link href={`/notes/tags/${tag.slug}`}>{tag.display}</Link>{index !== note.data.tags!.length - 1 && <span>, </span>}</Fragment>)}
  </div>

  <!-- Link and date -->
  <div class="flex justify-between items-center gap-2">
    <div class="flex items-center text-sm text-neutral-500">
      {showLink ? <Link href={`/notes/${note.id}`}>#{note.data.no}</Link> : <span>#{note.data.no}</span>}
      <span class="icon-[lucide--dot]" />
      <span>{format(note.data.created, "PP")}</span>
      {note.data.draft && <span class="ml-2 text-amber-600 dark:text-amber-400">Draft</span>}
    </div>
    {post && (
      <Link href={`/posts/${post.id}`} class="text-sm">
        <span>Read the full post</span>
        {post.data.lang !== "en" && `(in ${getLanguageEnglishDisplay(post.data.lang)})`}
        <span class="icon-[lucide--arrow-right] translate-y-px" />
      </Link>
    )}
  </div>
</div>
