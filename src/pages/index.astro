---
import { groupBy } from 'lodash-es'
import { getYear, format } from 'date-fns'
import { getPosts } from '@/utils/posts'

import Layout from '@/layouts/Layout.astro'
import ImageSlide from '@/components/ImageSlide.astro'
import { Content as Bio } from '@/blocks/bio.md'

import welcome from '@/assets/images/welcome.gif'

const posts = await getPosts()
const grouped = Object.entries(groupBy(posts, (post) => getYear(post.data.created)))
	.map(([year, posts]) => ({ year, posts: posts.toSorted((a, b) => b.data.created.valueOf() - a.data.created.valueOf()) }))
	.toSorted((a, b) => Number(b.year) - Number(a.year))
---

<Layout>
	<!-- Welcome -->
	<div class="flex flex-col items-center gap-4 my-16">
		<img src={welcome.src} alt="Welcome" width="140" />
	</div>

	<!-- Profile -->
	<div class="mb-16 py-4 space-y-4 bg-slate-50 border border-slate-200">
		<div class="px-4 paragraph-block">
			<Bio />
		</div>
		<ImageSlide />
	</div>
	
	<!-- Posts -->
	{grouped.map(({ year, posts }) => (
		<div class="my-8">
			<div class="pb-1 mb-2 border-b border-slate-200 text-slate-500 text-sm">{year}</div>
			<div>
				{posts.map((post) => (
					<div class="my-1 flex justify-between gap-4">
						<span>
							<a href={`/posts/${post.id}`}>{post.data.title}</a>
							{post.data.draft === true && <span class="i-lucide-file-pen ml-1 text-slate-500"></span>}
						</span>
						<span class="shrink-0 w-fit text-slate-500">{format(post.data.created, 'M æœˆ d æ—¥')}</span>
					</div>
				))}
			</div>
		</div>
	))}
</Layout>
